<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - AI Scan</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 pb-24">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6 py-4 border-b border-slate-800">
            <h1 class="text-xl font-black text-pink-500 uppercase tracking-widest">Master Admin</h1>
            <div id="sync-status" class="text-[9px] px-2 py-1 bg-slate-800 text-slate-500 rounded-full font-bold uppercase tracking-tighter">Ready</div>
        </header>

        <section class="bg-slate-800 rounded-3xl p-6 mb-6 shadow-2xl border border-slate-700">
            <div class="space-y-4">
                <input id="c-circle" type="text" placeholder="ã‚µãƒ¼ã‚¯ãƒ«å" class="w-full bg-slate-700 border-none p-4 rounded-2xl text-sm">
                <input id="c-item" type="text" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å" class="w-full bg-slate-700 border-none p-4 rounded-2xl text-sm">
                <input id="c-price" type="number" placeholder="ä¾¡æ ¼" class="w-full bg-slate-700 border-none p-4 rounded-2xl text-sm">
                <button onclick="addToCatalog()" class="w-full bg-pink-600 font-black py-4 rounded-2xl shadow-xl shadow-pink-900/20 active:scale-95 transition-all">è¿½åŠ ãƒ»æ›´æ–°</button>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-700">
                <p class="text-[10px] font-black text-pink-400 uppercase tracking-widest mb-3">AI Image Scan</p>
                <input id="ai-image" type="file" accept="image/*" class="hidden" onchange="handleAiScan(this)">
                <label for="ai-image" class="block w-full bg-slate-700 hover:bg-slate-600 text-center py-4 rounded-2xl cursor-pointer text-xs font-bold transition-all">ãŠå“æ›¸ãç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                <div id="ai-loading" class="hidden mt-3 text-center text-[10px] text-pink-500 animate-pulse font-bold">AI ANALYZING...</div>
            </div>
        </section>

        <div id="catalog-list" class="space-y-3"></div>
    </div>

    <script>
        let catalog = [];
        async function api(method='GET', type='catalog', data=null) {
            const pass = localStorage.getItem('vggc_admin_pass');
            const res = await fetch(`/api/manage?type=${type}`, {
                method, headers: {'Content-Type': 'application/json', 'x-admin-password': pass || ''},
                body: data ? JSON.stringify(data) : null
            });
            if (res.status === 403) {
                const p = prompt("Password:"); if(p) { localStorage.setItem('vggc_admin_pass', p); return api(method, type, data); }
            }
            return res.json();
        }

        async function init() { catalog = await api('GET'); render(); }
        function render() {
            const el = document.getElementById('catalog-list');
            el.innerHTML = catalog.map(i => `<div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex justify-between items-center"><div><div class="text-[9px] font-black text-pink-500 uppercase">${i.circle}</div><div class="font-bold">${i.item}</div><div class="text-xs font-medium text-slate-500">Â¥${i.price.toLocaleString()}</div></div><button onclick="deleteItem(${i.id})" class="text-slate-600 hover:text-red-500 p-2">ğŸ—‘ï¸</button></div>`).reverse().join('');
        }

        async function addToCatalog() {
            const circle = document.getElementById('c-circle').value, item = document.getElementById('c-item').value, price = parseInt(document.getElementById('c-price').value)||0;
            if(!circle||!item) return alert("å…¥åŠ›ã‚¨ãƒ©ãƒ¼");
            catalog.push({id: Date.now(), circle, item, price});
            await api('POST', 'catalog', catalog); render();
        }

        async function deleteItem(id) { if(confirm("å‰Šé™¤ï¼Ÿ")) { catalog = catalog.filter(i => i.id !== id); await api('POST', 'catalog', catalog); render(); } }

       async function handleAiScan(input) {
    if (!input.files[0]) return;
    const loading = document.getElementById('ai-loading');
    loading.classList.remove('hidden');

    try {
        // 1. ç”»åƒã‚’åœ§ç¸®ã™ã‚‹
        const compressedBase64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // æœ€å¤§æ¨ªå¹…ã‚’1000pxã«åˆ¶é™ã—ã¦ãƒªã‚µã‚¤ã‚º
                    const MAX_WIDTH = 1000;
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ç”»è³ªã‚’0.7(70%)ã«è½ã¨ã—ã¦Base64åŒ–ï¼ˆã“ã‚Œã§ã‚µã‚¤ã‚ºãŒæ¿€æ¸›ã—ã¾ã™ï¼‰
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                };
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(input.files[0]);
        });

        // 2. åœ§ç¸®ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’APIã«é€ã‚‹
        const res = await api('POST', 'dify', { image: compressedBase64 });

        if (!res || !res.answer) {
            throw new Error("AIã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Difyã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

        const jsonMatch = res.answer.match(/\[.*\]/s);
        if (!jsonMatch) {
            throw new Error("AIãŒæ­£ã—ã„å½¢å¼ã§å›ç­”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
        }

        const json = JSON.parse(jsonMatch[0]);
        catalog = [...catalog, ...json.map(i => ({ ...i, id: Date.now() + Math.random() }))];
        await api('POST', 'catalog', catalog);
        render();
        alert(`${json.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);

    } catch (e) {
        console.error("è©³ç´°ã‚¨ãƒ©ãƒ¼:", e);
        alert(`ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—: ${e.message}`);
    } finally {
        loading.classList.add('hidden');
        input.value = '';
    }
}
        init();
    </script>
</body>
</html>