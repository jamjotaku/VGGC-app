<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vspo! Event Catalog & Organizer</title>
    <style>
        :root {
            --vspo-pink: #ff69b4;
            --vspo-blue: #00bfff;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 120px; color: #333; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        header { background: #333; color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header-top { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; }
        .user-info { font-size: 0.9rem; color: var(--vspo-pink); cursor: pointer; font-weight: bold; }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .tab-btn {
            background: #555; border: none; color: white; padding: 10px 24px;
            border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .tab-btn.active { background: var(--vspo-pink); box-shadow: 0 0 10px rgba(255,105,180,0.5); }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 1100px; margin: 25px auto; padding: 0 15px; }
        .view { display: none; }
        .view.active { display: block; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .controls { 
            display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; 
            margin-bottom: 25px; background: white; padding: 18px; border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        @media (max-width: 768px) { .controls { grid-template-columns: 1fr; } }

        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ»ã‚«ãƒ¼ãƒ‰ */
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .item-card {
            background: var(--card-bg); border-radius: 15px; padding: 18px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s ease; position: relative;
        }
        .item-card.selected { border-color: var(--vspo-pink); background: #fff9fc; }
        .item-card:hover { transform: translateY(-4px); }

        .card-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .space-num { background: #eee; color: #444; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .item-type { font-size: 0.75rem; color: var(--vspo-blue); font-weight: bold; }
        .item-name { font-size: 1.05rem; font-weight: bold; margin: 10px 0; height: 2.6em; overflow: hidden; line-height: 1.3; }
        .item-price { color: var(--vspo-pink); font-size: 1.3rem; font-weight: bold; text-align: right; }

        /* ä¸‹éƒ¨åˆè¨ˆãƒãƒ¼ */
        .total-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            border-top: 2px solid var(--vspo-pink); padding: 18px 0;
            display: flex; justify-content: center; gap: 30px; align-items: center;
            z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        .total-info { font-size: 1.1rem; font-weight: bold; }
        .total-amount { font-size: 1.8rem; color: var(--vspo-pink); margin-left: 8px; }
        
        .action-btn { padding: 10px 18px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-reset { background: #888; color: white; }
        .btn-share { background: var(--vspo-blue); color: white; }

        #empty-msg { text-align: center; color: #999; margin-top: 60px; font-size: 1.1rem; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h2 style="margin:0; font-size:1.3rem;">Vspo! Catalog</h2>
        <div class="user-info" onclick="changeUser()">ğŸ‘¤ ID: <span id="user-display">---</span></div>
    </div>
    <nav class="nav-tabs">
        <button id="tab-catalog" class="tab-btn active" onclick="switchTab('catalog')">å…¨ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</button>
        <button id="tab-wishlist" class="tab-btn" onclick="switchTab('wishlist')">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</button>
    </nav>
</header>

<div class="container">
    <div id="catalog-view" class="view active">
        <div class="controls">
            <input type="text" id="search-input" placeholder="ã‚µãƒ¼ã‚¯ãƒ«ãƒ»å•†å“åãƒ»ç•ªå·ã§æ¤œç´¢...">
            <select id="type-filter"><option value="">ã™ã¹ã¦ã®ç¨®åˆ¥</option></select>
            <select id="sort-order">
                <option value="num-asc">ã‚µãƒ¼ã‚¯ãƒ«ç•ªå·é † (A-Z)</option>
                <option value="price-asc">ä¾¡æ ¼ã®å®‰ã„é †</option>
                <option value="price-desc">ä¾¡æ ¼ã®é«˜ã„é †</option>
            </select>
        </div>
        <div id="catalog-grid" class="item-grid"></div>
    </div>

    <div id="wishlist-view" class="view">
        <h3 id="wishlist-title" style="border-left: 5px solid var(--vspo-pink); padding-left: 10px;">ã‚ãªãŸã®ãƒªã‚¹ãƒˆ</h3>
        <div id="wishlist-grid" class="item-grid"></div>
        <div id="empty-msg">ã¾ã ãƒã‚§ãƒƒã‚¯ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </div>
</div>

<div class="total-bar">
    <div class="total-info">
        è¨ˆ <span id="total-count">0</span> ç‚¹ <span class="total-amount">Â¥<span id="total-val">0</span></span>
    </div>
    <button class="action-btn btn-reset" onclick="resetWishlist()">ã‚¯ãƒªã‚¢</button>
    <button class="action-btn btn-share" onclick="copyShareUrl()">å…±æœ‰URL</button>
</div>

<script>
    let catalogData = [];
    let wishlist = new Set();
    let currentUserId = "";

    async function init() {
        // 1. IDç®¡ç† (URLå„ªå…ˆ > ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
        const params = new URLSearchParams(window.location.search);
        currentUserId = params.get('id') || localStorage.getItem('vspo_last_user') || prompt("å€‹äººIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "guest") || "guest";
        localStorage.setItem('vspo_last_user', currentUserId);
        document.getElementById('user-display').textContent = currentUserId;

        // 2. ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚§ãƒƒãƒ
        try {
            const res = await fetch('catalog.json');
            catalogData = await res.json();
            
            // ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”Ÿæˆ
            const types = [...new Set(catalogData.map(d => d.type))].filter(Boolean);
            const filter = document.getElementById('type-filter');
            types.forEach(t => filter.innerHTML += `<option value="${t}">${t}</option>`);

            loadWishlist();
            applySort();
            render();
        } catch (e) {
            document.body.innerHTML = "<div style='padding:50px; text-align:center;'>catalog.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚GitHub Actionsã®å®Œäº†ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>";
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`${tab}-view`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        render();
    }

    // è‡ªç„¶é †ã‚½ãƒ¼ãƒˆã®å®Ÿè£…
    function applySort() {
        const order = document.getElementById('sort-order').value;
        catalogData.sort((a, b) => {
            if (order === 'num-asc') return (a.num || "").localeCompare(b.num || "", undefined, {numeric: true});
            return order === 'price-asc' ? (a.price || 0) - (b.price || 0) : (b.price || 0) - (a.price || 0);
        });
    }

    function render() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const typeFilter = document.getElementById('type-filter').value;
        const catalogGrid = document.getElementById('catalog-grid');
        const wishlistGrid = document.getElementById('wishlist-grid');

        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        const createCard = (d) => {
            const key = `${d.circle}_${d.item}`;
            const selected = wishlist.has(key);
            return `
                <div class="item-card ${selected ? 'selected' : ''}" onclick="toggleItem('${key}')">
                    <div class="card-header">
                        <span class="space-num">${d.num || '---'}</span>
                        <span>${d.circle || 'ã‚µãƒ¼ã‚¯ãƒ«åãªã—'}</span>
                    </div>
                    <div class="item-type">${d.type || ''}</div>
                    <div class="item-name">${d.item}</div>
                    <div class="item-price">Â¥${(d.price || 0).toLocaleString()}</div>
                </div>
            `;
        };

        // ä¸€è¦§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const filtered = catalogData.filter(d => {
            return (!typeFilter || d.type === typeFilter) && 
                   (!query || d.item.toLowerCase().includes(query) || d.circle.toLowerCase().includes(query) || d.num.toLowerCase().includes(query));
        });
        catalogGrid.innerHTML = filtered.map(createCard).join('');

        // è²·ã„ç‰©ãƒªã‚¹ãƒˆ
        const wishes = catalogData.filter(d => wishlist.has(`${d.circle}_${d.item}`));
        wishlistGrid.innerHTML = wishes.map(createCard).join('');
        document.getElementById('empty-msg').style.display = wishes.length ? 'none' : 'block';
        document.getElementById('wishlist-title').textContent = `${currentUserId} ã•ã‚“ã®è²·ã„ç‰©ãƒªã‚¹ãƒˆ (${wishes.length}ç‚¹)`;

        updateTotal(wishes);
    }

    function toggleItem(key) {
        if (wishlist.has(key)) wishlist.delete(key);
        else wishlist.add(key);
        localStorage.setItem(`wishlist_${currentUserId}`, JSON.stringify(Array.from(wishlist)));
        render();
    }

    function updateTotal(wishes) {
        const total = wishes.reduce((s, i) => s + (i.price || 0), 0);
        document.getElementById('total-val').textContent = total.toLocaleString();
        document.getElementById('total-count').textContent = wishes.length;
    }

    function loadWishlist() {
        const saved = localStorage.getItem(`wishlist_${currentUserId}`);
        wishlist = new Set(saved ? JSON.parse(saved) : []);
    }

    function changeUser() {
        const id = prompt("åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", currentUserId);
        if (id) {
            localStorage.setItem('vspo_last_user', id);
            window.location.search = `?id=${encodeURIComponent(id)}`;
        }
    }

    function copyShareUrl() {
        const url = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(currentUserId)}`;
        navigator.clipboard.writeText(url).then(() => alert("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼IDã”ã¨ã®ãƒªã‚¹ãƒˆã‚’å…±æœ‰ã§ãã¾ã™ã€‚"));
    }

    function resetWishlist() {
        if (confirm("é¸æŠã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            wishlist.clear();
            localStorage.removeItem(`wishlist_${currentUserId}`);
            render();
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('search-input').addEventListener('input', render);
    document.getElementById('type-filter').addEventListener('change', render);
    document.getElementById('sort-order').addEventListener('change', () => { applySort(); render(); });

    init();
</script>
</body>
</html>
