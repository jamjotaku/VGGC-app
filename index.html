<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vspo! Multi-User Organizer</title>
    <style>
        :root { --vspo-pink: #ff69b4; --vspo-blue: #00bfff; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px 20px 120px 20px; }
        
        /* IDç®¡ç†ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .user-session {
            background: #333; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 8px; margin-bottom: 20px;
        }
        .user-id-display { font-weight: bold; color: var(--vspo-pink); }

        .controls {
            max-width: 1100px; margin: 0 auto 20px;
            display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;
        }
        @media (max-width: 600px) { .controls { grid-template-columns: 1fr; } }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1100px; margin: 0 auto; }
        
        .item-card {
            background: white; border-radius: 12px; padding: 15px; position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; border: 2px solid transparent;
        }
        .item-card.selected { border-color: var(--vspo-pink); background: #fff9fc; }
        
        .circle-num { font-size: 0.8rem; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .item-price { color: var(--vspo-pink); font-weight: bold; font-size: 1.2rem; margin-top: 10px; }

        .total-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 2px solid var(--vspo-pink);
            padding: 15px; display: flex; justify-content: center; gap: 20px; align-items: center;
            z-index: 100; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="user-session" id="user-area">
    <div>ğŸ‘¤ User: <span id="display-user-id" class="user-id-display">æœªè¨­å®š</span></div>
    <button onclick="changeUser()" style="cursor:pointer">IDåˆ‡æ›¿</button>
</div>

<div class="controls">
    <input type="text" id="search-input" placeholder="æ¤œç´¢...">
    <select id="type-filter"><option value="">ã™ã¹ã¦</option></select>
    <select id="sort-order">
        <option value="num-asc">ã‚µãƒ¼ã‚¯ãƒ«ç•ªå·é †</option>
        <option value="price-asc">å®‰ã„é †</option>
        <option value="price-desc">é«˜ã„é †</option>
    </select>
</div>

<div id="catalog-container" class="item-grid"></div>

<div class="total-bar">
    <b>åˆè¨ˆ: Â¥<span id="total-amount">0</span></b>
    <small>(<span id="item-count">0</span> ç‚¹)</small>
    <button onclick="clearList()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    let catalogData = [];
    let currentUserId = "guest";
    let wishlist = new Set();

    // åˆæœŸåŒ–
    async function init() {
        // 1. IDã®ç¢ºèª
        currentUserId = localStorage.getItem('vspo_last_user') || prompt("åˆ©ç”¨ã™ã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: ã²ãªã®æ¨ã—)", "guest") || "guest";
        localStorage.setItem('vspo_last_user', currentUserId);
        document.getElementById('display-user-id').textContent = currentUserId;

        // 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        const res = await fetch('catalog.json');
        catalogData = await res.json();
        
        // 3. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã®å¾©å…ƒ
        loadWishlist();
        
        // 4. ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
        const types = [...new Set(catalogData.map(d => d.type))];
        types.forEach(t => document.getElementById('type-filter').innerHTML += `<option value="${t}">${t}</option>`);

        applySort();
        render();
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
    function saveWishlist() {
        localStorage.setItem(`wishlist_${currentUserId}`, JSON.stringify(Array.from(wishlist)));
    }
    function loadWishlist() {
        const saved = localStorage.getItem(`wishlist_${currentUserId}`);
        wishlist = new Set(saved ? JSON.parse(saved) : []);
    }

    function render() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const type = document.getElementById('type-filter').value;
        const container = document.getElementById('catalog-container');

        const filtered = catalogData.filter(d => {
            return (!type || d.type === type) && 
                   (!search || d.item.toLowerCase().includes(search) || d.circle.toLowerCase().includes(search) || d.num.toLowerCase().includes(search));
        });

        container.innerHTML = filtered.map(d => {
            const key = `${d.circle}_${d.item}`;
            const selected = wishlist.has(key);
            return `
                <div class="item-card ${selected ? 'selected' : ''}" onclick="toggleItem('${key}')">
                    <span class="circle-num">${d.num || '??'}</span> ${d.circle}
                    <div style="margin: 8px 0; font-weight:bold">${d.item}</div>
                    <div class="item-price">Â¥${(d.price || 0).toLocaleString()}</div>
                </div>
            `;
        }).join('');

        updateTotal();
    }

    function toggleItem(key) {
        if (wishlist.has(key)) wishlist.delete(key);
        else wishlist.add(key);
        saveWishlist();
        render();
    }

    function updateTotal() {
        let total = 0;
        catalogData.forEach(d => {
            if (wishlist.has(`${d.circle}_${d.item}`)) total += (d.price || 0);
        });
        document.getElementById('total-amount').textContent = total.toLocaleString();
        document.getElementById('item-count').textContent = wishlist.size;
    }

    function applySort() {
        const order = document.getElementById('sort-order').value;
        catalogData.sort((a, b) => {
            if (order === 'num-asc') return (a.num || "").localeCompare(b.num || "", undefined, {numeric: true});
            if (order === 'price-asc') return a.price - b.price;
            return b.price - a.price;
        });
    }

    function changeUser() {
        const newId = prompt("åˆ‡ã‚Šæ›¿ãˆã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", currentUserId);
        if (newId) {
            localStorage.setItem('vspo_last_user', newId);
            location.reload();
        }
    }

    function clearList() {
        if (confirm("ãƒªã‚¹ãƒˆã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
            wishlist.clear();
            saveWishlist();
            render();
        }
    }

    document.getElementById('search-input').addEventListener('input', render);
    document.getElementById('type-filter').addEventListener('change', render);
    document.getElementById('sort-order').addEventListener('change', () => { applySort(); render(); });

    init();
</script>
</body>
</html>
