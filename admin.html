<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Data Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .3; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 pb-24 font-sans">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6 py-4 border-b border-slate-800">
            <h1 class="text-xl font-black text-pink-500 uppercase tracking-widest">Master Admin</h1>
            <div id="sync-status" class="text-[9px] px-2 py-1 bg-slate-800 text-slate-500 rounded-full font-bold uppercase tracking-tighter">Verified</div>
        </header>

        <section class="bg-slate-800 rounded-3xl p-6 mb-6 shadow-2xl border-2 border-blue-500/20">
            <h2 class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-4">JSON Bulk Import</h2>
            <div class="space-y-4">
                <input id="json-file" type="file" accept=".json" class="hidden" onchange="handleJsonImport(this)">
                <label for="json-file" class="block w-full bg-blue-600 hover:bg-blue-500 text-center py-4 rounded-2xl cursor-pointer font-black text-xs transition-all active:scale-95 shadow-lg shadow-blue-900/40">
                    JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                </label>
            </div>
        </section>

        <section class="bg-slate-800 rounded-3xl p-6 mb-8 shadow-2xl border-2 border-pink-500/20">
            <h2 class="text-[10px] font-black text-pink-500 uppercase tracking-widest mb-4">AI Smart Scan</h2>
            <div class="space-y-4">
                <input id="ai-image" type="file" accept="image/*" class="hidden" onchange="handleAiScan(this)">
                <label for="ai-image" class="block w-full bg-pink-600 hover:bg-pink-500 text-center py-5 rounded-2xl cursor-pointer font-black text-sm transition-all shadow-lg shadow-pink-900/40 active:scale-95">
                    ãŠå“æ›¸ãã‚’ã‚¹ã‚­ãƒ£ãƒ³
                </label>
                <div id="ai-loading" class="hidden text-center text-[10px] text-pink-400 font-bold tracking-widest loading-pulse uppercase">Processing...</div>
            </div>
        </section>

        <details class="mb-8 group">
            <summary class="text-[10px] font-bold text-slate-500 cursor-pointer uppercase tracking-widest text-center group-open:mb-4 outline-none">Manual / Text Bulk</summary>
            <div class="bg-slate-800/50 rounded-2xl p-5 border border-slate-700 space-y-4">
                <textarea id="bulk-input" rows="3" placeholder="é…ç½®,ã‚µãƒ¼ã‚¯ãƒ«,ç¨®é¡,å“å,ä¾¡æ ¼" class="w-full bg-slate-700 border-none p-4 rounded-xl text-[10px] text-slate-100 placeholder-slate-600 focus:ring-2 focus:ring-pink-500 outline-none"></textarea>
                <button onclick="addBulk()" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-[10px] font-bold uppercase transition-colors">ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
            </div>
        </details>

        <div class="flex justify-between items-center mb-4 px-1">
            <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest italic">Catalog Assets</h2>
            <button onclick="clearAll()" class="text-[9px] text-red-900 hover:text-red-500 font-bold uppercase transition-all">å…¨æ¶ˆå»</button>
        </div>
        <div id="catalog-list" class="space-y-3"></div>
    </div>

    <script>
        let catalog = [];

        async function api(method='GET', type='catalog', data=null) {
            const pass = localStorage.getItem('vggc_admin_pass');
            try {
                const res = await fetch(`/api/manage?type=${type}`, {
                    method, headers: {'Content-Type': 'application/json', 'x-admin-password': pass || ''},
                    body: data ? JSON.stringify(data) : null
                });
                if (res.status === 403) {
                    const p = prompt("Password:");
                    if(p) { localStorage.setItem('vggc_admin_pass', p); return api(method, type, data); }
                }
                return res.json();
            } catch (err) { return {error: true}; }
        }

        // --- JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç† ---
        function handleJsonImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const validated = data.map(i => ({
                        id: Date.now() + Math.random(),
                        num: i.num || '--', circle: i.circle || 'ä¸æ˜',
                        type: i.type || 'ãã®ä»–', item: i.item || 'å“åä¸æ˜',
                        price: parseInt(i.price) || 0
                    }));
                    catalog = [...catalog, ...validated];
                    await api('POST', 'catalog', catalog);
                    render();
                    alert(`${validated.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
                } catch (err) { alert("JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- AIã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå¼·åŠ›åœ§ç¸®ç‰ˆï¼‰ ---
        async function handleAiScan(input) {
            if (!input.files[0]) return;
            const loading = document.getElementById('ai-loading');
            loading.classList.remove('hidden');
            try {
                const base64 = await new Promise(r => {
                    const rd = new FileReader(); rd.onload = e => {
                        const img = new Image(); img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 900; let w = img.width, h = img.height;
                            if(w > MAX){ h *= MAX/w; w = MAX; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            r(canvas.toDataURL('image/jpeg', 0.4).split(',')[1]);
                        }; img.src = e.target.result;
                    }; rd.readAsDataURL(input.files[0]);
                });
                const res = await api('POST', 'dify', { image: base64 });
                const jsonMatch = res.answer.match(/\[\s*\{.*\}\s*\]/s);
                if (jsonMatch) {
                    const items = JSON.parse(jsonMatch[0]).map(i => ({
                        id: Date.now()+Math.random(), num: i.num || '--', circle: i.circle || 'ä¸æ˜',
                        type: i.type || 'ãã®ä»–', item: i.item || 'ä¸æ˜', price: parseInt(i.price) || 0
                    }));
                    catalog = [...catalog, ...items];
                    await api('POST', 'catalog', catalog);
                    render();
                }
            } catch (e) { alert("ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼šç”»åƒã‚’ç¸®å°ã—ã¦è©¦ã—ã¦ãã ã•ã„"); }
            finally { loading.classList.add('hidden'); input.value=''; }
        }

        async function addBulk() {
            const text = document.getElementById('bulk-input').value.trim(); if(!text) return;
            const items = text.split('\n').map(l => {
                const [num, circle, type, item, price] = l.split(',').map(s => s.trim());
                return { id: Date.now()+Math.random(), num: num||'--', circle: circle||'ä¸æ˜', type: type||'ãã®ä»–', item: item||'æœªå…¥åŠ›', price: parseInt(price)||0 };
            });
            catalog = [...catalog, ...items]; await api('POST', 'catalog', catalog); 
            document.getElementById('bulk-input').value = ''; render();
        }

        function render() {
            const el = document.getElementById('catalog-list');
            catalog.sort((a, b) => (a.num || '').localeCompare(b.num || '', 'ja', {numeric: true}));
            el.innerHTML = catalog.map(i => `
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex items-center gap-4">
                    <div class="w-12 text-[9px] font-black text-pink-500 text-center bg-pink-500/10 py-2 rounded-lg uppercase">${i.num || '--'}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-500 truncate uppercase mb-0.5">${i.circle || 'ä¸æ˜'} | ${i.type || 'ãã®ä»–'}</div>
                        <div class="font-bold text-sm text-slate-100 truncate">${i.item || 'å“åä¸æ˜'}</div>
                        <div class="text-[10px] font-black text-pink-400 mt-1">Â¥${(i.price || 0).toLocaleString()}</div>
                    </div>
                    <button onclick="deleteItem(${i.id})" class="text-slate-600 hover:text-red-500 p-2 transition-all">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        async function init() { const data = await api('GET'); if(data && !data.error) { catalog = data; render(); } }
        async function deleteItem(id) { if(confirm("å‰Šé™¤ï¼Ÿ")) { catalog = catalog.filter(i => i.id !== id); await api('POST', 'catalog', catalog); render(); } }
        async function clearAll() { if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { catalog = []; await api('POST', 'catalog', catalog); render(); } }
        init();
    </script>
</body>
</html>