<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vspo! Goods Organizer</title>
    <style>
        :root {
            --vspo-pink: #ff69b4;
            --vspo-blue: #00bfff;
            --bg-color: #f0f2f5;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px 20px 120px 20px;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚¨ãƒªã‚¢ */
        .header-bar {
            max-width: 1100px;
            margin: 0 auto 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
        }

        .user-id { color: var(--vspo-pink); font-weight: bold; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .controls {
            max-width: 1100px;
            margin: 0 auto 30px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) { .controls { grid-template-columns: 1fr; } }

        input, select, button {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        button { background: var(--vspo-pink); color: white; border: none; cursor: pointer; }
        button:hover { opacity: 0.9; }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .item-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .item-card.selected {
            border-color: var(--vspo-pink);
            background-color: #fff9fc;
        }

        .item-card:hover { transform: translateY(-3px); }

        .circle-info { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .item-num { font-weight: bold; background: #eee; padding: 2px 6px; border-radius: 4px; color: #444; }
        .item-name { font-size: 1rem; font-weight: bold; margin: 10px 0; height: 2.5em; overflow: hidden; }
        .item-price { color: var(--vspo-pink); font-size: 1.2rem; font-weight: bold; }

        /* åˆè¨ˆé‡‘é¡ãƒãƒ¼ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰ */
        .total-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            z-index: 1000;
        }

        .total-info { font-size: 1.1rem; font-weight: bold; }
        .total-price { font-size: 1.8rem; color: var(--vspo-pink); margin-left: 10px; }

        .btn-copy { background: #666; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="header-bar">
    <div>ğŸ‘¤ ID: <span id="display-user-id" class="user-id">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    <div>
        <button class="btn-copy" onclick="copyShareUrl()">å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼</button>
        <button onclick="changeUser()">IDåˆ‡æ›¿</button>
    </div>
</div>

<div class="controls">
    <input type="text" id="search-input" placeholder="æ¤œç´¢ (ã‚µãƒ¼ã‚¯ãƒ«åãƒ»ã‚°ãƒƒã‚ºãƒ»ç•ªå·)...">
    <select id="type-filter"><option value="">ã™ã¹ã¦ã®ç¨®åˆ¥</option></select>
    <select id="sort-order">
        <option value="num-asc">ã‚µãƒ¼ã‚¯ãƒ«ç•ªå·é † (A-01...)</option>
        <option value="price-asc">ä¾¡æ ¼ã®å®‰ã„é †</option>
        <option value="price-desc">ä¾¡æ ¼ã®é«˜ã„é †</option>
    </select>
</div>

<div id="catalog-container" class="item-grid"></div>

<div class="total-bar">
    <div class="total-info">
        é¸æŠ: <span id="item-count">0</span> ç‚¹
        <span class="total-price">åˆè¨ˆ Â¥<span id="total-amount">0</span></span>
    </div>
    <button style="background:#888" onclick="resetWishlist()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    let catalogData = [];
    let currentUserId = "";
    let wishlist = new Set();

    async function init() {
        // 1. IDç®¡ç† (URLå„ªå…ˆ > LocalStorage > Prompt)
        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get('id');
        
        if (idFromUrl) {
            currentUserId = idFromUrl;
            localStorage.setItem('vspo_last_user', currentUserId);
        } else {
            currentUserId = localStorage.getItem('vspo_last_user') || prompt("åˆ©ç”¨ã™ã‚‹å€‹äººIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: hinano_fan)", "guest") || "guest";
            localStorage.setItem('vspo_last_user', currentUserId);
        }
        document.getElementById('display-user-id').textContent = currentUserId;

        // 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        try {
            const response = await fetch('catalog.json');
            catalogData = await response.json();
            
            // ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
            const types = [...new Set(catalogData.map(item => item.type))];
            const filter = document.getElementById('type-filter');
            types.forEach(t => { if(t) filter.innerHTML += `<option value="${t}">${t}</option>`; });

            loadWishlist();
            applySort();
            render();
        } catch (e) {
            document.getElementById('catalog-container').innerHTML = "catalog.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHub Actionsã®å®Œäº†ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚";
        }
    }

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¿å­˜ (IDã”ã¨ã«éµã‚’åˆ†ã‘ã‚‹)
    function saveWishlist() {
        localStorage.setItem(`wishlist_${currentUserId}`, JSON.stringify(Array.from(wishlist)));
    }

    function loadWishlist() {
        const saved = localStorage.getItem(`wishlist_${currentUserId}`);
        wishlist = new Set(saved ? JSON.parse(saved) : []);
    }

    // è‡ªç„¶ãªã‚½ãƒ¼ãƒˆ (C-1, C-10ãªã©ãŒæ­£ã—ãä¸¦ã¶ã‚ˆã†ã«)
    function applySort() {
        const order = document.getElementById('sort-order').value;
        catalogData.sort((a, b) => {
            if (order === "num-asc") {
                return (a.num || "").localeCompare((b.num || ""), undefined, { numeric: true, sensitivity: 'base' });
            } else if (order === "price-asc") {
                return (a.price || 0) - (b.price || 0);
            } else {
                return (b.price || 0) - (a.price || 0);
            }
        });
    }

    function render() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const type = document.getElementById('type-filter').value;
        const container = document.getElementById('catalog-container');

        const filtered = catalogData.filter(item => {
            const matchesSearch = !search || item.circle?.toLowerCase().includes(search) || item.item?.toLowerCase().includes(search) || item.num?.toLowerCase().includes(search);
            const matchesType = !type || item.type === type;
            return matchesSearch && matchesType;
        });

        container.innerHTML = filtered.map(item => {
            const key = `${item.circle}_${item.item}`;
            const isSelected = wishlist.has(key);
            return `
                <div class="item-card ${isSelected ? 'selected' : ''}" onclick="toggleWish('${key}')">
                    <div class="circle-info"><span class="item-num">${item.num || '---'}</span> ${item.circle || 'ä¸æ˜'}</div>
                    <div style="font-size:0.7rem; color:var(--vspo-blue)">${item.type}</div>
                    <div class="item-name">${item.item}</div>
                    <div class="item-price">Â¥${(item.price || 0).toLocaleString()}</div>
                </div>
            `;
        }).join('');

        updateTotal();
    }

    function toggleWish(key) {
        if (wishlist.has(key)) wishlist.delete(key);
        else wishlist.add(key);
        saveWishlist();
        render();
    }

    function updateTotal() {
        let total = 0;
        catalogData.forEach(item => {
            if (wishlist.has(`${item.circle}_${item.item}`)) total += (item.price || 0);
        });
        document.getElementById('total-amount').textContent = total.toLocaleString();
        document.getElementById('item-count').textContent = wishlist.size;
    }

    function changeUser() {
        const newId = prompt("æ–°ã—ã„IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", currentUserId);
        if (newId) {
            localStorage.setItem('vspo_last_user', newId);
            window.location.search = `?id=${encodeURIComponent(newId)}`;
        }
    }

    function copyShareUrl() {
        const url = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(currentUserId)}`;
        navigator.clipboard.writeText(url).then(() => alert("å…±æœ‰ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    }

    function resetWishlist() {
        if(confirm("ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
            wishlist.clear();
            saveWishlist();
            render();
        }
    }

    // ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.getElementById('search-input').addEventListener('input', render);
    document.getElementById('type-filter').addEventListener('change', render);
    document.getElementById('sort-order').addEventListener('change', () => { applySort(); render(); });

    init();
</script>

</body>
</html>